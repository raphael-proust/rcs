#!/bin/dash

TASKPIPESDIR="$HOME/.task-pipes"
if ! [ -d $TASKPIPESDIR ]
then
  mkdir $TASKPIPESDIR
fi

if [ $# -eq 0 ]
then
  TASKPIPES=$(ls $TASKPIPESDIR)
  TASKPIPE=$(printf %s "$TASKPIPES" | sed -e "s/\s\+/\n/g" | slmenu)
  if [ "x$TASKPIPE" = "x" ]
  then
    exit 0
  else
    exec dtach -A $TASKPIPESDIR/$TASKPIPE $SHELL
  fi
else
  case "$#" in
    (1)
      case "$1" in
        ("-l")
          printf %s "$(ls $TASKPIPESDIR)"
          ;;
        (*)
          exec dtach -A $TASKPIPESDIR/$1 $SHELL
          ;;
      esac
      ;;
    (2)
      case "$1" in
        ("-a")
          exec dtach -a $TASKPIPESDIR/$2
          ;;
        (*)
          exec dtach -A $TASKPIPESDIR/$1 $2
          ;;
      esac
      ;;
    (*)
      case "$1" in
        ("-a")
          echo "Invalid usage of -a"
          exit 1
          ;;
        ("-c"|"-n"|"-A")
          DASHARG=$1
          PIPENAME=$2
          shift 2
          exec dtach $DASHARG "$TASKPIPESDIR/$PIPENAME" $*
          ;;
        (*)
          PIPENAME=$1
          shift 1
          exec dtach -A $TASKPIPESDIR/$PIPENAME $*
          ;;
      esac
      ;;
  esac
fi

#Usage:
# task: prompt for a task to attach to using slmenu(1)
# task <name>: if the task <name> exists, attach to it
#              otherwise, create a shell ($SHELL) task named <name>
# task <name> <cmd>: if the task <name> exists, attach to it
#                    otherwise, create a <cmd> task named <name>
# task <-n|-c|-A> <name> <cmd>: see dtach(1) usage
# task <-a> <name>: see dtach(1) usage
