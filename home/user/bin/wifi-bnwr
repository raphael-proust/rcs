#!/bin/dash

check(){
  ping -c 1 -w 10 127.0.0.1 && \
  ping -c 1 -w 10 $(route -n | awk '/^0.0.0.0/ { print $2 }') && \
  exit 0
}

case "$1" in
  (d|down|disconnect)
    sudo netcfg down $(sudo netcfg current)
    RC=$?
    set-status-line-bnwr
    exit $RC
    ;;
  (o|off|block)
    sudo netcfg down $(sudo netcfg current)
    sudo rfkill block wifi
    RC=$?
    set-status-line-bnwr
    exit $RC
    ;;
  (on|unblock)
    sudo rfkill unblock wifi
    RC=$?
    set-status-line-bnwr
    exit $RC
    ;;
  (r|reco|reconnect)
    check
    sudo wpa_cli reassociate
    check
    sudo netcfg reconnect $(sudo netcfg current)
    set-status-line-bnwr
    check
    ;;
  (s|scan)
    sudo rfkill unblock wifi
    sudo ifconfig wlan0 up
    sudo iwlist wlan0 scan
    set-status-line-bnwr
    check
    ;;
  (check)
    check
    ;;
  (*)
    if netcfg list | grep -q $1
    then
      sudo rfkill unblock wifi
      sudo netcfg up $*
      set-status-line-bnwr
      check
    else
      cat <<EOF
wifi script usage:
	wifi command
	wifi profile

Available commands:
	d down disconnect: disconnect wifi profile
	o off block: disconnect wifi profile and shuts down wifi card
	r reco reconnect: reconnects current wifi profile
	s scan: scans wifi networks

Profiles are thoose defined in /etc/network.d
EOF
    fi
    ;;
esac
