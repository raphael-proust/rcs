#!/bin/dash

ALSAVOL=""
if which amixer >/dev/null
then
  ALSAVOL=$(amixer get Master | grep "Mono:" | sed -e "s/.*\[[0-9]*%\].*\[\(.*\)\]$/\1/")
  case "$ALSAVOL" in
    (on)
      ALSAVOL=$(amixer get Master | grep "Mono:" | sed -e "s/.*\[\([0-9]*%\)\].*\[.*\]$/\1/")
      ;;
    (off)
      ;;
  esac
fi

WIFI=""
if which rfkill >/dev/null
then
  if rfkill list wifi 2>/dev/null | grep -q "Soft blocked: no"
  then
    if which wpa_cli >/dev/null
    then
      WIFI=$(sudo wpa_cli status|grep "^ssid="|sed "s/^ssid=//")
    else
      WIFI="wlan"
    fi
  fi
fi

POWERSRC=$(acpi -a | sed 's/Adapter .: //; s/on-line/AC:/g; s/off-line/Bat:/g;') \
POWERLVL=$(acpi -b | sed 's/Battery .:.* \([0-9]*%\).*$/\1/') \


CPUGOV=""
if which cpupower >/dev/null
then
  CPUGOV=$(cpupower -c 0 frequency-info -p | grep '".*"' | sed -e 's/^.*"\(.*\)".*$/\1/')
  case "$CPUGOV" in
    (ondemand)
      CPUGOV=""
    ;;
  esac
fi

if [ -e /sys/kernel/debug/vgaswitcheroo/switch ]
then
  GPUSTATE=$(cat /sys/kernel/debug/vgaswitcheroo/switch |grep DIS| sed 's/.:DIS:.:\([^:]*\):.*/\1/')
  case "$GPUSTATE" in
    (Pwr)
      GPUSTATE="GPU"
      ;;
    (Off)
      GPUSTATE=""
      ;;
  esac
else
  GPUSTATE=""
fi

TASKS=$(task -l)

DATE=$(date '+%Y-%m-%d %a  %H:%M')

printf " %s | %s | vol: %s | %s %s | %s | %s | %s" \
  "$TASKS" \
  "$WIFI" \
  "$ALSAVOL"  \
  "$POWERSRC" "$POWERLVL" \
  "$CPUGOV" \
  "$GPUSTATE" \
  "$DATE"

