#!/bin/dash

ALSAVOL=""
if which amixer >/dev/null
then
  ALSAVOL=$(amixer get Master | grep "Mono:" | sed -e "s/.*\[[0-9]*%\].*\[\(.*\)\]$/\1/")
  case "$ALSAVOL" in
    (on)
      ALSAVOL=$(amixer get Master | grep "Mono:" | sed -e "s/.*\[\([0-9]*%\)\].*\[.*\]$/\1/")
      ;;
    (off)
      ;;
  esac
fi

WIFI=""
if which rfkill >/dev/null
then
  if rfkill list wifi 2>/dev/null | grep -q "Soft blocked: no"
  then
    if which wpa_cli >/dev/null
    then
      WIFI=$(printf "| %s" $(sudo wpa_cli status|grep "^ssid="|sed "s/^ssid=//"))
    else
      WIFI="| wlan"
    fi
  fi
fi

POWERSRC=$(acpi -a | sed 's/Adapter .: //; s/on-line/AC:/g; s/off-line/Bat:/g;') \
POWERLVL=$(acpi -b | sed 's/Battery .:.* \([0-9]*%\).*$/\1/') \


CPUGOV=""
if which cpupower >/dev/null
then
  CPUGOV=$(cpupower -c 0 frequency-info -p|tail -n 1|awk '{print $3}')
  case "$CPUGOV" in
    (ondemand)
      CPUGOV=""
    ;;
    (powersave|performance)
      CPUGOV=$(printf "%s | " "$CPUGOV")
    ;;
  esac
fi

if [ -e /sys/kernel/debug/vgaswitcheroo/switch ]
then
  GPUSTATE=$(cat /sys/kernel/debug/vgaswitcheroo/switch |grep DIS| sed 's/.:DIS:.:\([^:]*\):.*/\1/')
  case "$GPUSTATE" in
    (Pwr)
      GPUSTATE="GPU on | "
      ;;
    (Off)
      GPUSTATE=""
      ;;
  esac
else
  GPUSTATE=""
fi

TUNNEL=""
if [ -e $HOME/.task-pipes/sock ]
then
	TUNNEL="tunnel | "
fi

DATE=$(date '+%Y-%m-%d %a  %H:%M')

printf " vol: %s %s | %s%s %s | %s%s%s" \
  "$ALSAVOL"  \
  "$WIFI" \
  "$TUNNEL" \
  "$POWERSRC" "$POWERLVL" \
  "$CPUGOV" \
  "$GPUSTATE" \
  "$DATE"

