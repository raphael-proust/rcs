#!/bin/dash

ALSAVOL=""
if which amixer >/dev/null
then
  ALSAVOL=$(amixer get Master | grep "Mono:" | sed -e "s/.*\[[0-9]*%\].*\[\(.*\)\]$/\1/")
  case "$ALSAVOL" in
    (on)
      ALSAVOL=$(amixer get Master | grep "Mono:" | sed -e "s/.*\[\([0-9]*%\)\].*\[.*\]$/\1/")
      ;;
    (off)
      ;;
  esac
fi

WIFI=""
if which rfkill >/dev/null
then
  if rfkill list wifi 2>/dev/null | grep -q "Soft blocked: no"
  then
    WIFI="wlan: on"
  fi
fi

POWERSRC=$(acpi -a | sed 's/Adapter .: //; s/on-line/AC:/g; s/off-line/Bat:/g;') \
POWERLVL=$(acpi -b | sed 's/Battery .:.* \([0-9]*%\).*$/\1/') \


CPUGOV=""
if which cpufreq-info >/dev/null
then
  CPUGOV=$(cpufreq-info -c 0 -p | awk '{print $3}')
  case "$CPUGOV" in
    (ondemand)
      CPUGOV=""
    ;;
    (powersave|performance)
      CPUGOV=$(printf "%s | " "$CPUGOV")
    ;;
  esac
fi

if [ -e /sys/kernel/debug/vgaswitcheroo/switch ]
then
  GPUSTATE=$(cat /sys/kernel/debug/vgaswitcheroo/switch |grep DIS| sed 's/.:DIS:.:\([^:]*\):.*/\1/')
  case "$GPUSTATE" in
    (Pwr)
      GPUSTATE="GPU on | "
      ;;
    (Off)
      GPUSTATE=""
      ;;
  esac
else
  GPUSTATE=""
fi

DATE=$(date '+%Y-%m-%d %a  %H:%M')

printf " vol: %s | %s | %s %s | %s%s%s" \
  "$ALSAVOL"  \
  "$WIFI" \
  "$POWERSRC" "$POWERLVL" \
  "$CPUGOV" \
  "$GPUSTATE" \
  "$DATE"

