#!/usr/bin/env rc

fn sigint{
	set-status-line-bnwr `{status-line-bnwr}
	exit
}

fn eth0{
	switch ($1) {
	case d
		sudo dhcpcd --release eth0
	case k
		sudo ip link set eth0 down
	case o
		sudo ip link set eth0 up
	case c
		sudo dhcpcd  --timeout 60 eth0
	case r
		sudo dhcpcd --release eth0
		sudo dhcpcd --timeout 60 eth0
	case a
		ip addr show eth0
	case *
		network $1
	}
}
fn wlan0{
	switch ($1) {
	case d
		sudo dhcpcd --release wlan0
		sudo pkill -9 -u root wpa_supplicant
	case k
		sudo rfkill block wifi
		sudo ip link set wlan0 down
	case o
		sudo rfkill unblock wifi
		sudo ip link set wlan0 up
	case c
		sudo wpa_supplicant -B -Dwext -i wlan0 -c /etc/wpa_supplicant/wpa_supplicant.conf
		sudo dhcpcd --timeout 60 wlan0
	case s
		sudo ip link set wlan0 up
		sudo iwlist wlan0 scan
	case r
		sudo dhcpcd --release wlan0
		sudo dhcpcd --timeout 60 wlan0
	case R
		sudo wpa_cli reassociate
	case a
		ip addr show wlan0
	case *
		network $1
	}
}
fn network{
	switch ($1) {
	case p
		ping -c 1 -w 10 `{route -n | grep '^0.0.0.0' | tr -s ' ' '	' | cut -f 2}
	case P
		ping -c 1 -w 5 free.fr &
		ping -c 1 -w 5 google.com &
		ping -c 1 -w 5 ovh.com &
		ping -c 1 -w 5 github.com &
		ping -c 1 -w 5 twitter.com &
		wait
	case t
		if (~ `{ssh-add -L} 'The agent has no identities.') ssh-add
		task -n sock ssh -v -ND 4711 lum
	case T
		if (~ `{ssh-add -L} 'The agent has no identities.') ssh-add
		task sock ssh -v -ND 4711 lum
	case a
		ip addr show
	}
}

mode=wlan0

for (i) {
	switch($i){
		case w
			mode=wlan0
		case e
			mode=eth0
		case n
			mode=network
		case *
			$mode $i
	}
}
set-status-line-bnwr `{status-line-bnwr}
